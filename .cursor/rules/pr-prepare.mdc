---
description: Rules for preparing PR descriptions with QA results
globs: ["**/*"]
alwaysApply: false
---

# PR Preparation Rules

When user asks to "prepare PR", "review for PR", or "create PR description":

## Step 1: Identify Changed Tables & Downstream Dependencies

1. **Look at git diff** to identify which model files (.sql) were modified
2. **Map files to tables** - e.g., `models/Modelling/Main/fact_order_lines.sql` ‚Üí `fact_order_lines`
3. **Identify downstream tables** that depend on the changed tables:

| If Changed | Also Check (Downstream) |
|------------|------------------------|
| `fact_order_lines` | `OrderLinesMaster` |
| `fact_overall_advertising` | `AdvertisingMasterAll` |
| `dim_*` tables | Any fact tables that reference them |
| Prerequisites tables | Their corresponding main layer tables |

**ONLY run QA on:**
- ‚úÖ Tables directly modified in this PR
- ‚úÖ Downstream tables that depend on modified tables
- ‚ùå NOT all tables in the qa_config.yml

## Step 2: Run QA Checks on Affected Tables Only

For ONLY the changed tables + downstream dependencies identified in Step 1:

**Follow the existing QA rules defined in:**
- `qa-check-standards.mdc` - For the 8 standard checks (freshness, nulls, duplicates, RI, invalid values, distribution, logic change, data impact)
- `qa-thresholds.mdc` - For pass/fail thresholds
- `qa-output-format.mdc` - For output formatting
- `known-issues.mdc` - To exclude known/accepted issues

Run checks using BigQuery MCP.

## Step 3: Save QA Results to File

Save the full QA report to:
```
/qa/QA Results/PR-QA-{branch-name}-{YYYY-MM-DD}.md
```

Example: `/qa/QA Results/PR-QA-abhishek-dev-2025-11-28.md`

The QA report format should follow `qa-output-format.mdc` exactly.

## Step 4: Generate PR Description File

Save PR description to: `.github/pr-body.md`

Format:
```markdown
## üìù What Changed
[Actual description of changes based on modified files]

## üéØ Tables Affected
- table_name_1
- table_name_2

## ‚úÖ Pre-Merge Checklist
- [x] Code reviewed by Cursor AI
- [x] QA checks executed
- [x] QA report saved to /qa/QA Results/
- [ ] No breaking changes to downstream tables

## üìä QA Check Results

| Table | Freshness | Nulls | Duplicates | Ref. Integrity | Invalid Values | Logic Change | Data Impact | Overall |
|-------|-----------|-------|------------|----------------|----------------|--------------|-------------|---------|
| table_1 | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ Pass |

**Full QA Report:** [PR-QA-{branch-name}-{date}.md](../qa/QA%20Results/PR-QA-{branch-name}-{date}.md)

## ‚ö†Ô∏è Known Issues (Not Blocking)
[List any known issues from known-issues.mdc that were found]

## üìã Health Score
Overall: X% (based on qa-thresholds.mdc calculation)
```

## Step 5: Commit, Push & Create PR with GitHub CLI

After generating both files, commit and provide the GitHub CLI commands.

### 5.1 Stage and Commit

```bash
git add "qa/QA Results/" .github/pr-body.md
git commit -m "Add QA results for PR"
```

### 5.2 Push to Remote

```bash
git push origin {branch-name}
```

### 5.3 Create New PR (if PR doesn't exist)

```bash
gh pr create \
  --title "{PR Title - descriptive of changes}" \
  --body-file .github/pr-body.md \
  --base main \
  --head {branch-name}
```

**Example:**
```bash
gh pr create \
  --title "Add documentation: sales_deepdive, marketing_deepdive, and QA framework" \
  --body-file .github/pr-body.md \
  --base main
```

### 5.4 Update Existing PR (if PR already exists)

```bash
# Push new commits (PR auto-updates)
git push origin {branch-name}

# Optionally update PR title/body
gh pr edit {PR-number} --body-file .github/pr-body.md
gh pr edit {PR-number} --title "New Title"
```

### 5.5 One-Liner Command (New PR)

Provide this single command for the user to copy-paste:

```bash
git push origin {branch-name} && gh pr create --title "{PR Title}" --body-file .github/pr-body.md --base main
```

### 5.6 Check PR Status

```bash
# List open PRs
gh pr list

# View specific PR
gh pr view {PR-number}

# Open PR in browser
gh pr view --web
```

## Step 6: Final Output to User

Always end PR preparation with:

1. **Summary table** of commits and files
2. **GitHub CLI command** ready to copy-paste
3. **PR link** (if PR already exists)

Example output:
```
## ‚úÖ PR Preparation Complete!

### Commits in This PR
| Commit | Description |
|--------|-------------|
| abc123 | Add comments to model |

### üöÄ Create PR Command

Copy and run this command:

```bash
git push origin abhishek-dev && gh pr create --title "Add documentation to presentation models" --body-file .github/pr-body.md --base main
```

Or if PR already exists, just push:
```bash
git push origin abhishek-dev
```

**Existing PR:** https://github.com/gorillacommerce/gorillacommerce_edm/pull/XXX
```

## Automation Flow

The entire flow should be:
1. User asks: "Prepare PR for my changes"
2. Cursor runs QA, saves results, generates PR body
3. Cursor commits all files
4. Cursor provides GitHub CLI command to push + create PR
5. User runs the command
6. PR is created with filled description automatically

## GitHub CLI Prerequisites

If `gh` commands fail, user needs to:
```bash
# Install GitHub CLI (if not installed)
brew install gh

# Authenticate
gh auth login

# Set default repo (if needed)
gh repo set-default
```
